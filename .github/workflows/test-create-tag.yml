name: Test create-tag Action

on:
  pull_request:
    paths:
      - '.github/actions/create-tag/**'
      - '.github/workflows/test-create-tag.yml'
  workflow_dispatch:

# Only allow one concurrent test run
concurrency:
  group: test-create-tag-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Test 1: Basic tag creation with default prefix
  test-basic-tag:
    name: 'Test: Basic Tag Creation'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create Unique Test Tag
        id: create-tag
        uses: ./.github/actions/create-tag
        with:
          version: '0.0.0-test-${{ github.run_number }}'
          push: 'false' # Don't push test tags

      - name: Verify Tag Created
        run: |
          if [ "${{ steps.create-tag.outputs.success }}" != "true" ]; then
            echo "âŒ Tag creation failed"
            exit 1
          fi

          TAG="${{ steps.create-tag.outputs.tag_name }}"
          if [ -z "$TAG" ]; then
            echo "âŒ Tag name not set in output"
            exit 1
          fi

          # Verify tag exists locally
          if ! git tag -l | grep -q "^${TAG}$"; then
            echo "âŒ Tag ${TAG} not found in git"
            exit 1
          fi

          echo "âœ… Tag ${TAG} created successfully"

      - name: Cleanup Test Tag
        if: always()
        run: |
          TAG="${{ steps.create-tag.outputs.tag_name }}"
          if [ -n "$TAG" ] && git tag -l | grep -q "^${TAG}$"; then
            git tag -d "$TAG"
            echo "ðŸ§¹ Cleaned up test tag: $TAG"
          fi

  # Test 2: Custom prefix
  test-custom-prefix:
    name: 'Test: Custom Tag Prefix'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create Tag with Custom Prefix
        id: create-tag
        uses: ./.github/actions/create-tag
        with:
          version: '0.0.0-test-${{ github.run_number }}'
          tag_prefix: 'release/'
          push: 'false'

      - name: Verify Custom Prefix
        run: |
          TAG="${{ steps.create-tag.outputs.tag_name }}"
          if [[ ! "$TAG" =~ ^release/ ]]; then
            echo "âŒ Tag does not start with 'release/' prefix: $TAG"
            exit 1
          fi

          # Verify tag exists
          if ! git tag -l | grep -q "^${TAG}$"; then
            echo "âŒ Tag ${TAG} not found"
            exit 1
          fi

          echo "âœ… Custom prefix tag created: $TAG"

      - name: Cleanup
        if: always()
        run: |
          TAG="${{ steps.create-tag.outputs.tag_name }}"
          if [ -n "$TAG" ] && git tag -l | grep -q "^${TAG}$"; then
            git tag -d "$TAG"
          fi

  # Test 3: Version format validation
  test-version-validation:
    name: 'Test: Version Format Validation'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Test Valid Version (x.y.z)
        id: valid-version
        uses: ./.github/actions/create-tag
        with:
          version: '1.2.3-test-${{ github.run_number }}'
          push: 'false'

      - name: Verify Valid Version Succeeded
        run: |
          if [ "${{ steps.valid-version.outputs.success }}" != "true" ]; then
            echo "âŒ Valid version format was rejected"
            exit 1
          fi
          echo "âœ… Valid version accepted"

      - name: Test Valid Version with v Prefix
        id: valid-with-prefix
        uses: ./.github/actions/create-tag
        with:
          version: 'v1.2.3-test-${{ github.run_number }}'
          push: 'false'

      - name: Verify v-Prefixed Version Succeeded
        run: |
          if [ "${{ steps.valid-with-prefix.outputs.success }}" != "true" ]; then
            echo "âŒ Valid v-prefixed version was rejected"
            exit 1
          fi
          echo "âœ… v-prefixed version accepted"

      - name: Test Invalid Version Format (should fail)
        id: invalid-version
        continue-on-error: true
        uses: ./.github/actions/create-tag
        with:
          version: 'not-a-version'
          push: 'false'

      - name: Verify Invalid Version Failed
        run: |
          if [ "${{ steps.invalid-version.outcome }}" != "failure" ]; then
            echo "âŒ Invalid version format was accepted (should have failed)"
            exit 1
          fi
          echo "âœ… Invalid version correctly rejected"

      - name: Cleanup
        if: always()
        run: |
          # Clean up any test tags that were created
          git tag -l | grep "test-${{ github.run_number }}" | xargs -r git tag -d || true

  # Test 4: Duplicate tag handling
  test-duplicate-handling:
    name: 'Test: Duplicate Tag Handling'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create Initial Tag
        id: first-tag
        uses: ./.github/actions/create-tag
        with:
          version: '0.0.0-dup-test-${{ github.run_number }}'
          push: 'false'

      - name: Verify First Tag Succeeded
        run: |
          if [ "${{ steps.first-tag.outputs.success }}" != "true" ]; then
            echo "âŒ First tag creation failed"
            exit 1
          fi
          echo "âœ… First tag created: ${{ steps.first-tag.outputs.tag_name }}"

      - name: Attempt Duplicate Tag
        id: duplicate-tag
        uses: ./.github/actions/create-tag
        with:
          version: '0.0.0-dup-test-${{ github.run_number }}'
          push: 'false'

      - name: Verify Duplicate Handling
        run: |
          # Should complete without error but report success=false
          if [ "${{ steps.duplicate-tag.outputs.success }}" == "true" ]; then
            echo "âŒ Duplicate tag reported success (should be false)"
            exit 1
          fi

          if [ "${{ steps.duplicate-tag.outputs.tag_name }}" != "${{ steps.first-tag.outputs.tag_name }}" ]; then
            echo "âŒ Tag names don't match between first and duplicate attempt"
            exit 1
          fi

          echo "âœ… Duplicate tag correctly handled (success=false, no error)"

      - name: Cleanup
        if: always()
        run: |
          TAG="${{ steps.first-tag.outputs.tag_name }}"
          if [ -n "$TAG" ] && git tag -l | grep -q "^${TAG}$"; then
            git tag -d "$TAG"
          fi

  # Test 5: Push control
  test-push-control:
    name: 'Test: Push Control'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create Tag Without Push
        id: no-push
        uses: ./.github/actions/create-tag
        with:
          version: '0.0.0-no-push-${{ github.run_number }}'
          push: 'false'

      - name: Verify Tag Exists Locally
        run: |
          TAG="${{ steps.no-push.outputs.tag_name }}"

          # Verify local tag exists
          if ! git tag -l | grep -q "^${TAG}$"; then
            echo "âŒ Tag not found locally"
            exit 1
          fi

          # Verify tag was NOT pushed (check if it exists on remote)
          # This test assumes the tag shouldn't exist on remote yet
          if git ls-remote --tags origin | grep -q "refs/tags/${TAG}"; then
            echo "âš ï¸  Tag exists on remote (this might be from a previous test)"
          else
            echo "âœ… Tag correctly created locally only (not pushed)"
          fi

      - name: Cleanup
        if: always()
        run: |
          TAG="${{ steps.no-push.outputs.tag_name }}"
          if [ -n "$TAG" ] && git tag -l | grep -q "^${TAG}$"; then
            git tag -d "$TAG"
          fi

  # Test 6: Empty prefix (no prefix)
  test-no-prefix:
    name: 'Test: No Prefix'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create Tag Without Prefix
        id: create-tag
        uses: ./.github/actions/create-tag
        with:
          version: '0.0.0-no-prefix-${{ github.run_number }}'
          tag_prefix: ''
          push: 'false'

      - name: Verify No Prefix
        run: |
          TAG="${{ steps.create-tag.outputs.tag_name }}"
          EXPECTED="0.0.0-no-prefix-${{ github.run_number }}"

          if [ "$TAG" != "$EXPECTED" ]; then
            echo "âŒ Tag name mismatch. Expected: $EXPECTED, Got: $TAG"
            exit 1
          fi

          # Verify tag exists
          if ! git tag -l | grep -q "^${TAG}$"; then
            echo "âŒ Tag not found"
            exit 1
          fi

          echo "âœ… Tag created without prefix: $TAG"

      - name: Cleanup
        if: always()
        run: |
          TAG="${{ steps.create-tag.outputs.tag_name }}"
          if [ -n "$TAG" ] && git tag -l | grep -q "^${TAG}$"; then
            git tag -d "$TAG"
          fi

  # Summary job
  test-summary:
    name: 'Test Summary'
    runs-on: ubuntu-latest
    needs:
      - test-basic-tag
      - test-custom-prefix
      - test-version-validation
      - test-duplicate-handling
      - test-push-control
      - test-no-prefix
    if: always()
    steps:
      - name: Check Test Results
        run: |
          echo "## create-tag Action Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          RESULTS=(
            "Basic Tag Creation:${{ needs.test-basic-tag.result }}"
            "Custom Prefix:${{ needs.test-custom-prefix.result }}"
            "Version Validation:${{ needs.test-version-validation.result }}"
            "Duplicate Handling:${{ needs.test-duplicate-handling.result }}"
            "Push Control:${{ needs.test-push-control.result }}"
            "No Prefix:${{ needs.test-no-prefix.result }}"
          )

          ALL_PASSED=true
          for result in "${RESULTS[@]}"; do
            TEST_NAME="${result%:*}"
            TEST_RESULT="${result#*:}"

            if [ "$TEST_RESULT" == "success" ]; then
              echo "- âœ… $TEST_NAME" >> $GITHUB_STEP_SUMMARY
            else
              echo "- âŒ $TEST_NAME (${TEST_RESULT})" >> $GITHUB_STEP_SUMMARY
              ALL_PASSED=false
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$ALL_PASSED" == "true" ]; then
            echo "### âœ… All tests passed!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The create-tag action is working correctly and is ready for marketplace publication." >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Some tests failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please review the failed tests above and fix any issues before proceeding." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
