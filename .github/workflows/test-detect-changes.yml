name: Test detect-changes Action

on:
  pull_request:
    paths:
      - 'actions/detect-changes/**'
      - '.github/workflows/test-detect-changes.yml'
  workflow_dispatch:

jobs:
  test-path-based:
    name: Test Path-Based Detection
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Test Action (Path-Based)
        id: changes
        uses: ./actions/detect-changes
        with:
          baseRef: ${{ github.event.pull_request.base.ref || 'develop' }}
          domains-config: |
            actions:
              paths:
                - 'actions/**'
            workflows:
              paths:
                - '.github/workflows/**'
            src:
              paths:
                - 'src/**'
            docs:
              paths:
                - 'docs/**'
                - '**.md'

      - name: Display Results
        run: |
          echo "ðŸ“‹ Change Detection Results:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Changes JSON:"
          echo '${{ steps.changes.outputs.changes }}' | jq '.'
          echo ""
          echo "Affected Domains: ${{ steps.changes.outputs.affectedDomains }}"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Validate JSON Output
        run: |
          # Ensure output is valid JSON
          echo '${{ steps.changes.outputs.changes }}' | jq empty || {
            echo "âŒ Invalid JSON output"
            exit 1
          }
          echo "âœ… JSON output is valid"

      - name: Test Conditional Execution
        if: fromJSON(steps.changes.outputs.changes).actions == true
        run: |
          echo "âœ… Actions domain changed - this step should run!"

  test-matrix-strategy:
    name: Test Matrix Strategy
    runs-on: ubuntu-latest
    outputs:
      domains: ${{ steps.changes.outputs.affectedDomains }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect Changes
        id: changes
        uses: ./actions/detect-changes
        with:
          baseRef: ${{ github.event.pull_request.base.ref || 'develop' }}
          domains-config: |
            actions:
              paths:
                - 'actions/**'
            workflows:
              paths:
                - '.github/workflows/**'
            src:
              paths:
                - 'src/**'
            docs:
              paths:
                - 'docs/**'

  process-domains:
    name: Process Domain (${{ matrix.domain }})
    needs: test-matrix-strategy
    if: needs.test-matrix-strategy.outputs.domains != ''
    strategy:
      matrix:
        domain: ${{ fromJSON(format('["{0}"]', needs.test-matrix-strategy.outputs.domains)) }}
    runs-on: ubuntu-latest
    steps:
      - name: Process Domain
        run: |
          echo "ðŸŽ¯ Processing domain: ${{ matrix.domain }}"
          echo "This job runs only for affected domains"

  test-no-changes:
    name: Test No Changes Scenario
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Test with Non-existent Paths
        id: changes
        uses: ./actions/detect-changes
        with:
          baseRef: ${{ github.event.pull_request.base.ref || 'develop' }}
          domains-config: |
            nonexistent:
              paths:
                - 'this/does/not/exist/**'

      - name: Verify No Changes
        run: |
          if [ "${{ steps.changes.outputs.affectedDomains }}" == "" ]; then
            echo "âœ… Correctly detected no changes"
          else
            echo "âŒ Unexpectedly detected changes: ${{ steps.changes.outputs.affectedDomains }}"
            exit 1
          fi

  summary:
    name: Test Summary
    needs: [test-path-based, test-matrix-strategy, test-no-changes]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Summary
        run: |
          echo "## ðŸ“Š Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Path-Based Detection | ${{ needs.test-path-based.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Matrix Strategy | ${{ needs.test-matrix-strategy.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| No Changes Scenario | ${{ needs.test-no-changes.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.test-path-based.result }}" == "success" ] && \
             [ "${{ needs.test-matrix-strategy.result }}" == "success" ] && \
             [ "${{ needs.test-no-changes.result }}" == "success" ]; then
            echo "### âœ… All tests passed!" >> $GITHUB_STEP_SUMMARY
            exit 0
          else
            echo "### âŒ Some tests failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
